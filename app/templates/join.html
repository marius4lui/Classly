{% extends "base.html" %}

{% block title %}Beitreten - Classly{% endblock %}

{% block content %}
<div class="join-container">
    <div class="join-header">
        <h1>{{ clazz.name }}</h1>
        <p>Willkommen! Melde dich an oder tritt bei.</p>
    </div>

    <!-- Clean Tabs -->
    <div class="join-tabs">
        <button class="join-tab active" onclick="switchMode('name')" id="tab-name">
            Mit Name
        </button>
        <button class="join-tab" onclick="switchMode('email')" id="tab-email">
            Mit Email
        </button>
        <div class="tab-indicator" id="tabIndicator"></div>
    </div>

    <!-- Mode 1: Join/Login with Name -->
    <div id="mode-name" class="join-panel active">
        {% if request.query_params.get("mode") == "oauth" or request.query_params.get("mode") == "saml" or request.query_params.get("mode") == "ldap" %}
        <div class="info-box" style="background-color: #e6fffa; border-color: #38b2ac; color: #234e52; margin-bottom: 1rem;">
            <strong>Anmeldung erfolgreich!</strong><br>
            Bitte vervollständige dein Profil, um beizutreten.
            <!-- Hidden inputs will be injected via cookie logic on backend, or we could pass them here if we read the cookie in the GET route.
                 Since the backend reads the cookie, we just need to provide the 'auth_provider' hidden field to trigger that logic.
                 Wait, the backend checks 'auth_provider_form'.
            -->
        </div>
        {% endif %}

        <form hx-post="/auth/join" hx-swap="none">
            {% if token_type == 'class' %}
            <input type="hidden" name="join_token" value="{{ clazz.join_token }}">
            {% elif token_type == 'login' %}
            <input type="hidden" name="login_token" value="{{ login_token }}">
            {% endif %}

             <!-- If we are in oauth mode, we send the provider name from query param or a generic indicator -->
              {% if pending_auth %}
                 <input type="hidden" name="auth_provider" value="{{ pending_auth.provider }}">
                 <div style="margin-bottom: 1rem; padding: 0.5rem; background: #eee; border-radius: 4px;">
                     Verknüpft mit <strong>{{ pending_auth.provider|title }}</strong> ({{ pending_auth.email }})
                 </div>
              {% endif %}

            <div class="form-group">
                <label>Dein Name</label>
                <input type="text" name="user_name" placeholder="Max Mustermann" required autofocus>
            </div>

            <p class="info-box">
                Falls du schon Mitglied bist, wirst du automatisch eingeloggt.
            </p>

            <!-- Optional Email Section -->
            <details class="email-details">
                <summary>
                    <span>Account mit Email sichern</span>
                    <span class="optional-badge">optional</span>
                </summary>
                <div class="details-content">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" placeholder="deine@email.de">
                    </div>
                    <div class="form-group">
                        <label>Passwort (min. 8 Zeichen)</label>
                        <input type="password" name="password" placeholder="Passwort wählen" minlength="8">
                    </div>
                </div>
            </details>

            <button type="submit" class="btn btn-primary btn-block">Beitreten</button>
        </form>
    </div>

    <!-- Mode 2: Login with Email -->
    <div id="mode-email" class="join-panel">
        <form hx-post="/auth/login-class" hx-swap="none">
            <input type="hidden" name="class_id" value="{{ clazz.id }}">

            <div class="form-group">
                <label>Email</label>
                <input type="email" name="email" required placeholder="deine@email.de">
            </div>
            <div class="form-group">
                <label>Passwort</label>
                <input type="password" name="password" required placeholder="Dein Passwort">
            </div>

            <button type="submit" class="btn btn-primary btn-block">Anmelden</button>

            <p class="info-box" style="margin-top: 1rem;">
                Nur für Mitglieder mit registriertem Account.
            </p>
        </form>
    </div>
</div>

<style>
    .join-container {
        max-width: 400px;
        margin: 0 auto;
        padding: 3rem 1.25rem;
    }

    .join-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .join-header h1 {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .join-header p {
        color: #888;
        font-size: 0.95rem;
    }

    /* Tabs */
    .join-tabs {
        display: flex;
        position: relative;
        background: #f5f5f5;
        border-radius: 10px;
        padding: 4px;
        margin-bottom: 1.5rem;
    }

    .join-tab {
        flex: 1;
        padding: 0.75rem 1rem;
        border: none;
        background: transparent;
        color: #666;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        border-radius: 8px;
        transition: color 0.2s;
        position: relative;
        z-index: 1;
    }

    .join-tab.active {
        color: #000;
    }

    .tab-indicator {
        position: absolute;
        top: 4px;
        left: 4px;
        width: calc(50% - 4px);
        height: calc(100% - 8px);
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: transform 0.25s ease;
    }

    .join-tabs.right .tab-indicator {
        transform: translateX(100%);
    }

    /* Panels */
    .join-panel {
        display: none;
        background: #fff;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    }

    .join-panel.active {
        display: block;
        animation: fadeUp 0.2s ease;
    }

    @keyframes fadeUp {
        from {
            opacity: 0;
            transform: translateY(6px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Form Elements */
    .join-panel .form-group {
        margin-bottom: 1rem;
    }

    .join-panel label {
        display: block;
        font-size: 0.85rem;
        font-weight: 500;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .join-panel input[type="text"],
    .join-panel input[type="email"],
    .join-panel input[type="password"] {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.2s, box-shadow 0.2s;
        background: #fff;
        color: #333;
    }

    .join-panel input:focus {
        outline: none;
        border-color: #000;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
    }

    .join-panel input::placeholder {
        color: #999;
    }

    /* Info Box */
    .info-box {
        font-size: 0.85rem;
        color: #666;
        padding: 0.75rem 1rem;
        background: #f8f8f8;
        border-radius: 8px;
        margin: 1rem 0;
        line-height: 1.5;
    }

    /* Details/Summary for Email Section */
    .email-details {
        margin: 1.25rem 0;
        border: 1px solid #e8e8e8;
        border-radius: 8px;
    }

    .email-details summary {
        display: flex;
        align-items: center;
        padding: 0.875rem 1rem;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        color: #444;
        list-style: none;
    }

    .email-details summary::-webkit-details-marker {
        display: none;
    }

    .email-details summary::before {
        content: "+";
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        margin-right: 0.75rem;
        background: #000;
        color: #fff;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 600;
    }

    .email-details[open] summary::before {
        content: "−";
    }

    .optional-badge {
        margin-left: auto;
        font-size: 0.75rem;
        color: #999;
        font-weight: 400;
    }

    .details-content {
        padding: 0 1rem 1rem 1rem;
        border-top: 1px solid #f0f0f0;
        margin-top: 0.5rem;
        padding-top: 1rem;
    }

    /* Button */
    .join-panel .btn {
        width: 100%;
        padding: 0.875rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 8px;
        margin-top: 0.5rem;
    }

    /* Dark Mode Support */
    @media (prefers-color-scheme: dark) {
        .join-tabs {
            background: #1a1a1a;
        }

        .join-tab {
            color: #888;
        }

        .join-tab.active {
            color: #fff;
        }

        .tab-indicator {
            background: #333;
        }

        .join-panel {
            background: #1a1a1a;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
        }

        .join-panel label {
            color: #eee;
        }

        .join-panel input {
            background: #222;
            border-color: #333;
            color: #fff;
        }

        .join-panel input:focus {
            border-color: #fff;
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }

        .join-panel input::placeholder {
            color: #666;
        }

        .info-box {
            background: #222;
            color: #aaa;
        }

        .email-details {
            border-color: #333;
        }

        .email-details summary {
            color: #ccc;
        }

        .email-details summary::before {
            background: #fff;
            color: #000;
        }

        .details-content {
            border-color: #333;
        }
    }
</style>

<script>
    function switchMode(mode) {
        const tabs = document.querySelector('.join-tabs');

        // Update tab states
        document.querySelectorAll('.join-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + mode).classList.add('active');

        // Move indicator
        if (mode === 'email') {
            tabs.classList.add('right');
        } else {
            tabs.classList.remove('right');
        }

        // Switch panels
        document.querySelectorAll('.join-panel').forEach(p => p.classList.remove('active'));
        document.getElementById('mode-' + mode).classList.add('active');
    }
</script>
{% endblock %}