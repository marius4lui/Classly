<!DOCTYPE html>
<html lang="de">

<head>
    {% if gtm_id %}
    <!-- Google Tag Manager Consent Mode -->
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }

        // Default consent status
        if (!localStorage.getItem('cookie_consent')) {
            gtag('consent', 'default', {
                'analytics_storage': 'denied',
                'ad_storage': 'denied',
                'wait_for_update': 500
            });
        } else {
            const consent = JSON.parse(localStorage.getItem('cookie_consent'));
            gtag('consent', 'default', {
                'analytics_storage': consent.analytics ? 'granted' : 'denied',
                'ad_storage': consent.ads ? 'granted' : 'denied'
            });
        }
    </script>

    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', '{{ gtm_id }}');</script>
    <!-- End Google Tag Manager -->
    {% endif %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="description"
        content="Classly - Die einfachste Art, deine Schulklasse zu organisieren. Stundenplan, Hausaufgaben und Termine an einem Ort.">
    <meta name="keywords" content="Classly, Schule, Organisation, Stundenplan, Hausaufgaben, Termine, Klasse">
    <meta property="og:title" content="Classly - Klassenorganisation leicht gemacht">
    <meta property="og:description"
        content="Organisiere deine Klasse effizient mit Classly. Alle wichtigen Infos auf einen Blick.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://classly.site/">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#ffffff">
    <title>{% block title %}{{ app_name }}{% endblock %}</title>
    <link rel="icon" href="{{ app_favicon_url }}">
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <link rel="stylesheet" href="/static/styles.css?v=5">
    <style>
        :root {
            {% if primary_color %}
            --primary: {{ primary_color }};
            --fg: {{ primary_color }}; /* Override foreground if primary is set, but be careful */
            {% endif %}

            {% if secondary_color %}
            --success: {{ secondary_color }}; /* Mapping secondary to success as requested in memory or just defined */
            {% endif %}
        }

        /* If primary_color is set, we might need to adjust button colors specifically if they relied on --fg */
        {% if primary_color %}
        .btn-primary {
            background: var(--primary);
            color: #ffffff;
        }
        /* Ensure text remains readable if --fg is changed globally (which we probably shouldn't do if it affects all text) */
        /* Let's NOT change --fg globally if it affects black text. */
        {% endif %}

        /* Proper Override Logic */
        {% if primary_color %}
        :root {
            --primary: {{ primary_color }};
            /* We don't change --fg because it's text color.
               But we change .btn-primary and other brand elements to use --primary */
        }
        .btn-primary, .badge-primary, .fab, .day-cell.selected {
            background: var(--primary) !important;
            color: #fff !important;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary), transparent 85%) !important;
        }
        .sidebar-link.active {
            color: var(--primary) !important;
            background: color-mix(in srgb, var(--primary), transparent 90%) !important;
        }
        .tab.active {
            color: var(--primary) !important;
            border-bottom-color: var(--primary) !important;
        }
        {% endif %}

        {% if secondary_color %}
        :root {
            --secondary-brand: {{ secondary_color }};
        }
        .btn-secondary {
            background: color-mix(in srgb, var(--secondary-brand), white 80%);
            color: var(--secondary-brand);
        }
        {% endif %}

        /* Dark Mode Overrides */
        [data-theme="dark"] {
            --bg: #111111;
            --fg: #ffffff;
            --gray-50: #1a1a1a;
            --gray-100: #262626;
            --gray-200: #333333;
            --gray-300: #4d4d4d;
            --gray-400: #666666;
            --gray-500: #888888;
            --gray-600: #999999;
            --gray-700: #cccccc;
            --gray-800: #eeeeee;

            /* Dark mode specific adjustments */
            --bg-card: #1a1a1a;
        }

        [data-theme="dark"] .card,
        [data-theme="dark"] .member-item,
        [data-theme="dark"] .upcoming-item,
        [data-theme="dark"] .token-item,
        [data-theme="dark"] .modal,
        [data-theme="dark"] .header {
            background: var(--gray-50);
            border-color: var(--gray-200);
        }

        [data-theme="dark"] input,
        [data-theme="dark"] select,
        [data-theme="dark"] textarea {
            background: var(--bg);
            border-color: var(--gray-300);
            color: var(--fg);
        }

        [data-theme="dark"] .calendar-wrapper,
        [data-theme="dark"] .calendar-header,
        [data-theme="dark"] .calendar-day-header,
        [data-theme="dark"] .calendar-cell {
            background: var(--bg);
            border-color: var(--gray-200);
        }

        [data-theme="dark"] .calendar-cell:active,
        [data-theme="dark"] .calendar-cell:hover {
            background: var(--gray-100);
        }

        [data-theme="dark"] .calendar-cell.other-month {
            background: #000;
        }

        [data-theme="dark"] .nav-btn {
            background: var(--bg);
            color: var(--fg);
            border-color: var(--gray-200);
        }

        [data-theme="dark"] .nav-btn:hover {
            background: var(--gray-100);
        }
    </style>
    <script>
        // Theme Logic
        (function() {
            const defaultTheme = "{{ default_theme }}";
            const allowToggle = {{ 'true' if allow_user_theme_toggle else 'false' }};
            const savedTheme = localStorage.getItem('theme');

            let theme = defaultTheme;
            if (allowToggle && savedTheme) {
                theme = savedTheme;
            } else if (defaultTheme === 'auto') {
                theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
</head>

<body>
    {% if gtm_id %}
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id={{ gtm_id }}" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    {% endif %}
    <main class="{% block main_class %}container{% endblock %}">
        {% block content %}{% endblock %}
    </main>
    <footer style="margin-top: 3rem; padding-bottom: 2rem; text-align: center; font-size: 0.85rem; color: #999;">
        <a href="/impressum" style="color: inherit; text-decoration: none; margin: 0 0.5rem;">Impressum</a>
        &bull;
        <a href="/datenschutz" style="color: inherit; text-decoration: none; margin: 0 0.5rem;">Datenschutz</a>
        &bull;
        <a href="https://info.classly.site/status/classly-info" target="_blank"
            style="color: inherit; text-decoration: none; margin: 0 0.5rem;">Status</a>

        {% if allow_user_theme_toggle %}
        <div style="margin-top: 1rem;">
            <button onclick="toggleTheme()" class="btn btn-sm btn-ghost">ðŸŒ“ Theme wechseln</button>
        </div>
        <script>
            function toggleTheme() {
                const html = document.documentElement;
                if (html.getAttribute('data-theme') === 'dark') {
                    html.removeAttribute('data-theme');
                    localStorage.setItem('theme', 'light');
                } else {
                    html.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                }
            }
        </script>
        {% endif %}
    </footer>

    {% if gtm_id %}
    <!-- Cookie Consent Banner -->
    <div id="cookie-banner"
        style="display: none; position: fixed; bottom: 20px; left: 20px; right: 20px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); color: #333; padding: 20px; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); z-index: 9999; max-width: 500px; margin: 0 auto;">
        <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 10px;">Cookies & Datenschutz</div>
        <p style="font-size: 0.9rem; line-height: 1.4; margin-bottom: 20px; color: #666;">
            Wir nutzen Cookies, um die Nutzererfahrung zu verbessern und die Seitennutzung zu analysieren. Mit Klick auf
            "Alle akzeptieren" stimmst du der Verwendung von Analyse-Cookies zu.
        </p>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="acceptAllCookies()"
                style="background: #000; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; flex: 1; transition: opacity 0.2s;">Alle
                akzeptieren</button>
            <button onclick="rejectAllCookies()"
                style="background: #f0f0f0; color: #333; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; flex: 1; transition: background 0.2s;">Ablehnen</button>
        </div>
    </div>

    <script>
        function updateGTMConsent(granted) {
            gtag('consent', 'update', {
                'analytics_storage': granted ? 'granted' : 'denied'
            });
        }

        function acceptAllCookies() {
            const consent = { analytics: true, ads: false, date: new Date().toISOString() };
            localStorage.setItem('cookie_consent', JSON.stringify(consent));
            updateGTMConsent(true);
            document.getElementById('cookie-banner').style.display = 'none';
        }

        function rejectAllCookies() {
            const consent = { analytics: false, ads: false, date: new Date().toISOString() };
            localStorage.setItem('cookie_consent', JSON.stringify(consent));
            updateGTMConsent(false);
            document.getElementById('cookie-banner').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', function () {
            if (!localStorage.getItem('cookie_consent')) {
                document.getElementById('cookie-banner').style.display = 'block';
            }
        });
    </script>
    {% endif %}
</body>

</html>