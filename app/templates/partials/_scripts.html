<script>
    const USER_ROLE = "{{ user.role.value }}";
    function esc(value) {
        return String(value ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }
    function safeUrl(raw) {
        try {
            const url = new URL(String(raw || ''), window.location.origin);
            if (url.protocol === 'http:' || url.protocol === 'https:') return url.href;
        } catch (_) { }
        return '#';
    }
    // Toast Function
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `<div class="toast-message">${esc(message)}</div>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.3s forwards';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Custom Confirm
    let confirmCallback = null;
    function showConfirm(message, callback) {
        document.getElementById('confirmMessage').innerText = message;
        document.getElementById('confirmModal').classList.add('active');
        confirmCallback = callback;
    }
    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.remove('active');
        confirmCallback = null;
    }
    document.getElementById('confirmBtnAction').onclick = () => {
        if (confirmCallback) confirmCallback();
        closeConfirmModal();
    };

    // Intercept HTMX Confirm
    document.body.addEventListener('htmx:confirm', function (evt) {
        if (!evt.detail.question) return;
        evt.preventDefault();
        showConfirm(evt.detail.question, () => {
            evt.detail.issueRequest(true);
        });
    });

    // Handle HTMX Errors
    document.body.addEventListener('htmx:responseError', function (evt) {
        showToast('Fehler bei der Anfrage', 'error');
    });

    function openModal(date) {
        document.getElementById('eventModal').classList.add('active');
        if (date) document.getElementById('eventDate').value = date;
        selectType('HA');
    }
    function closeModal() { document.getElementById('eventModal').classList.remove('active'); }
    function openRegisterModal() { document.getElementById('registerModal').classList.add('active'); }
    function closeRegisterModal() { document.getElementById('registerModal').classList.remove('active'); }

    function selectType(type) {
        document.querySelectorAll('.type-option').forEach(el => el.classList.remove('selected'));
        document.querySelector(`input[value="${type}"]`).checked = true;
        document.querySelector(`input[value="${type}"]`).closest('.type-option').classList.add('selected');

        // Handle Info type date requirement
        const dateInput = document.getElementById('eventDate');
        const dateGroup = dateInput.closest('.form-group');
        const label = dateGroup.querySelector('label');

        if (type === 'INFO') {
            dateInput.required = false;
            // Visual cue
            label.innerHTML = "Datum <span class='text-muted font-normal' style='font-weight:normal'>(Optional)</span>";
        } else {
            dateInput.required = true;
            label.innerText = "Datum";
        }
    }

    function showTab(name) {
        // Activate tab button
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(t => { if (t.textContent.toLowerCase().includes(name.substring(0, 3))) t.classList.add('active'); });
        // Activate tab content
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + name).classList.add('active');
        // Scroll to admin section on mobile
        document.querySelector('.admin-section')?.scrollIntoView({ behavior: 'smooth' });
    }

    // FAB functions
    function toggleFab() {
        const container = document.getElementById('fabContainer');
        const icon = document.getElementById('fabIcon');
        container.classList.toggle('open');
        icon.textContent = container.classList.contains('open') ? '√ó' : '+';
    }
    function closeFab() {
        const container = document.getElementById('fabContainer');
        const icon = document.getElementById('fabIcon');
        container.classList.remove('open');
        icon.textContent = '+';
    }

    function copyText(id) { navigator.clipboard.writeText(document.getElementById(id).value); }
    function copyToClipboard(text) { navigator.clipboard.writeText(text); }

    function toggleNameInput() {
        const select = document.getElementById('userSelect');
        const nameGroup = document.getElementById('nameInputGroup');
        const roleGroup = document.getElementById('roleInputGroup');
        const nameInput = document.getElementById('userNameInput');
        if (select.value) {
            nameGroup.style.display = 'none';
            roleGroup.style.display = 'none';
            nameInput.required = false;
        } else {
            nameGroup.style.display = 'block';
            roleGroup.style.display = 'block';
            nameInput.required = true;
        }
    }
    // Initialize on page load
    if (document.getElementById('userSelect')) toggleNameInput();

    // Event Detail Functions
    let currentEventId = null;
    let currentEventData = null; // Store data for switching views

    async function refreshEventDetailContent(eventId) {
        // Loading state
        document.getElementById('eventDetailContent').innerHTML = '<p class="text-muted text-center">Laden...</p>';

        try {
            const res = await fetch(`/events/${eventId}`);
            if (!res.ok) throw new Error('Not found');
            currentEventData = await res.json();
            renderViewMode(); // Default to view mode
        } catch (e) {
            console.error(e);
            document.getElementById('eventDetailContent').innerHTML = '<p class="text-muted text-center">Fehler beim Laden</p>';
        }
    }

    // Helper to render tree
    function renderTopicsTree(topics, eventId, canEdit) {
        if (!topics || topics.length === 0) return canEdit ? '' : '<p class="text-muted text-xs">Keine Themen eingetragen</p>';

        // 1. Map to dictionary
        const map = {};
        topics.forEach(t => map[t.id] = { ...t, children: [] });

        // 2. Build tree
        const roots = [];
        topics.forEach(t => {
            if (t.parent_id && map[t.parent_id]) {
                map[t.parent_id].children.push(map[t.id]);
            } else {
                roots.push(map[t.id]);
            }
        });

        // 3. Recursive render function
        function renderNode(node, level = 0) {
            const padding = level * 20;
            const topicType = esc(node.type);
            const topicContent = esc(node.content || '');
            const topicPages = esc(node.pages || '');
            const topicCount = esc(node.count || '');
            let html = `
                <div class="topic-item" style="margin-left: ${padding}px">
                    <span>
                        ${level > 0 ? '‚Ü≥ ' : ''}<strong>${topicType}</strong> ${topicContent} ${topicPages ? `(${topicPages})` : (topicCount ? `(${topicCount})` : '')}
                    </span>
                    ${canEdit ? `<button class="btn btn-ghost btn-sm" onclick="deleteTopic('${eventId}', '${node.id}')">√ó</button>` : ''}
                </div>
            `;
            if (node.children && node.children.length > 0) {
                node.children.forEach(c => html += renderNode(c, level + 1));
            }
            return html;
        }

        return roots.map(r => renderNode(r)).join('');
    }

    function updateTopicPreview() {
        const type = document.getElementById('inputTopicType').value || 'Thema';
        const content = document.getElementById('inputTopicContent').value || 'Details';
        const pages = document.getElementById('inputTopicPages').value;

        const pagesText = pages ? `(${pages})` : '';

        document.getElementById('topicPreview').innerHTML = `
            <span><strong>${esc(type)}</strong> ${esc(content)} ${esc(pagesText)}</span>
        `;
        document.getElementById('topicPreview').classList.remove('opacity-50');
    }

    function updateLinkPreview() {
        const label = document.getElementById('inputLinkLabel').value || 'Link Name';
        document.getElementById('linkPreview').innerHTML = `
            <a href="#" style="text-decoration: underline; color: var(--primary);">${esc(label)} ‚Üó</a>
            `;
        document.getElementById('linkPreview').classList.remove('opacity-50');
    }

    function renderViewMode() {
        if (!currentEventData) return;
        const event = currentEventData;
        const canEdit = USER_ROLE !== 'guest';

        // Topics List (Read-only)
        let topicsHtml = '';
        if ((event.topics && event.topics.length > 0) || event.type === 'KA' || event.type === 'TEST') {
            topicsHtml = `
                <hr>
                <h3 class="text-sm mb-2">Themen</h3>
                <div id="topicsList">
                    ${renderTopicsTree(event.topics || [], event.id, false)}
                </div>
            `;
        }

        // Links List (Read-only)
        let linksHtml = '';
        if (event.links && event.links.length > 0) {
            linksHtml = `
                <hr>
                <h3 class="text-sm mb-2">Links</h3>
                <div id="linksList">
                    ${event.links.map(l => `
                        <div class="topic-item">
                            <a href="${safeUrl(l.url)}" target="_blank" rel="noopener noreferrer" style="text-decoration: underline; color: var(--primary);">${esc(l.label)} ‚Üó</a>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Grade Section (only for KA/TEST and registered users)
        let gradeHtml = '';
        if ((event.type === 'KA' || event.type === 'TEST') && IS_REGISTERED) {
            gradeHtml = `
                <hr>
                <h3 class="text-sm mb-2">üìù Deine Note</h3>
                <div id="gradeSection">
                    <div class="add-grade-btn" onclick="openGradeModal('${event.id}')" id="gradeLoadingBtn">
                        <span>‚è≥</span> Lade...
                    </div>
                </div>
            `;
        }

        // Footer / Actions
        // Clear previous footer buttons first
        const modalFooter = document.querySelector('#eventDetailModal .modal-footer');
        modalFooter.innerHTML = '';

        if (canEdit) {
            const editBtn = document.createElement('button');
            editBtn.className = 'btn btn-primary';
            editBtn.textContent = 'Bearbeiten';
            editBtn.onclick = () => renderEditMode();
            modalFooter.appendChild(editBtn);
        }

        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn btn-secondary';
        closeBtn.textContent = 'Schlie√üen';
        closeBtn.onclick = closeEventDetail;
        modalFooter.appendChild(closeBtn);


        // Main Content
        document.getElementById('eventDetailContent').innerHTML = `
            <div class="event-detail-header">
                <div>
                    <span class="upcoming-type ${event.type.toLowerCase()}">${event.type}</span>
                     ${event.priority === 'high' ? '<span class="text-error font-bold ml-2">üî¥ Hoch</span>' : (event.priority === 'low' ? '<span class="text-muted ml-2">Niedrig</span>' : '')}
                </div>
                <span class="text-muted text-sm">${event.date || 'Info'}</span>
            </div>
            <h2 class="mt-2">${esc(event.subject_name || 'Allgemein')}</h2>
            ${event.title ? `<p class="text-muted">${esc(event.title)}</p>` : ''}
            <p class="text-xs text-muted mt-2">Erstellt von ${esc(event.author)}</p>

            ${topicsHtml}
            ${linksHtml}
            ${gradeHtml}
        `;

        // Load grade asynchronously if applicable
        if ((event.type === 'KA' || event.type === 'TEST') && IS_REGISTERED) {
            loadAndDisplayGrade(event.id, event.type);
        }
    }

    async function loadAndDisplayGrade(eventId, eventType = 'KA') {
        const gradeSection = document.getElementById('gradeSection');
        if (!gradeSection) return;

        try {
            const res = await fetch(`/grades/event/${eventId}`);
            if (res.ok) {
                const data = await res.json();
                if (data.grade !== null) {
                    // Show existing grade with weight
                    const weightLabel = data.weight === 1.0 ? '' : ` (√ó${data.weight})`;
                    gradeSection.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                            <span class="event-grade-badge">üìù ${data.grade.toFixed(1)}${weightLabel}</span>
                            <button class="btn btn-sm btn-secondary" onclick="openGradeModal('${eventId}', ${data.grade}, ${data.weight}, '${eventType}')">√Ñndern</button>
                        </div>
                    `;
                } else {
                    // Show add button
                    gradeSection.innerHTML = `
                        <div class="add-grade-btn" onclick="openGradeModal('${eventId}', null, null, '${eventType}')">
                            <span>‚ûï</span> Note hinzuf√ºgen
                        </div>
                    `;
                }
            } else if (res.status === 403) {
                // Not registered
                gradeSection.innerHTML = `
                    <p class="text-xs text-muted">Registriere dich, um Noten zu erfassen</p>
                `;
            }
        } catch (e) {
            console.error('Failed to load grade', e);
            gradeSection.innerHTML = `
                <div class="add-grade-btn" onclick="openGradeModal('${eventId}', null, null, '${eventType}')">
                    <span>‚ûï</span> Note hinzuf√ºgen
                </div>
            `;
        }
    }

    function renderEditMode() {
        if (!currentEventData) return;
        const event = currentEventData;

        // Topics Edit
        let topicsHtml = '';
        if (event.type === 'KA' || event.type === 'TEST') {
            // Prepare options for parent selector
            const topicOptions = (event.topics || []).map(t =>
                `<option value="${t.id}">${t.type} ${t.content || ''}</option>`
            ).join('');

            topicsHtml = `
                <hr>
                <h3 class="text-sm mb-2">Themen</h3>
                <div id="topicsList">
                    ${renderTopicsTree(event.topics || [], event.id, true)}
                </div>
                
                <div class="card bg-base-200 p-2 mt-4">
                    <h4 class="text-xs font-bold mb-2">Neues Thema hinzuf√ºgen</h4>
                    <form onsubmit="addTopic(event, '${event.id}')" id="addTopicForm">
                        <div class="form-row mb-2">
                            <div class="form-group" style="flex: 2;">
                                <input type="text" name="topic_type" id="inputTopicType" placeholder="Thema (z.B. Vokabeln)" required 
                                    oninput="updateTopicPreview()">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <select name="parent_id">
                                    <option value="">-- Hauptthema --</option>
                                    ${topicOptions}
                                </select>
                            </div>
                        </div>
                        <div class="form-row mb-2">
                            <div class="form-group" style="flex: 2;">
                                <input type="text" name="content" id="inputTopicContent" placeholder="Details" 
                                    oninput="updateTopicPreview()">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <input type="text" name="pages" id="inputTopicPages" placeholder="Seiten (z.B. 10-12)" 
                                    oninput="updateTopicPreview()">
                            </div>
                        </div>
                        
                        <div class="text-xs text-muted mb-1">Vorschau:</div>
                        <div id="topicPreview" class="topic-item mb-2 opacity-50">
                            <span><strong>Thema</strong> Details (S. 0-0)</span>
                        </div>

                        <button type="submit" class="btn btn-secondary btn-sm btn-block">+ Hinzuf√ºgen</button>
                    </form>
                </div>
            `;
        }

        // Links Edit
        let linksHtml = `
            <hr>
            <h3 class="text-sm mb-2">Links</h3>
            <div id="linksList">
                ${(event.links || []).map(l => `
                    <div class="topic-item" style="justify-content: space-between;">
                        <a href="${safeUrl(l.url)}" target="_blank" rel="noopener noreferrer" style="text-decoration: underline; color: var(--primary);">${esc(l.label)} ‚Üó</a>
                        <button class="btn btn-ghost btn-sm text-danger" onclick="deleteLink('${event.id}', '${l.id}')">√ó</button>
                    </div>
                `).join('')}
            </div>
            
            <div class="card bg-base-200 p-2 mt-4">
                <h4 class="text-xs font-bold mb-2">Neuen Link hinzuf√ºgen</h4>
                <form onsubmit="addLink(event, '${event.id}')" id="addLinkForm" class="flex gap-2">
                    <input type="text" name="label" id="inputLinkLabel" placeholder="Name" required style="flex:1;" oninput="updateLinkPreview()">
                    <input type="url" name="url" placeholder="URL" required style="flex:2;">
                    <button type="submit" class="btn btn-secondary btn-sm">+</button>
                </form>
                    <div class="text-xs text-muted mt-2 mb-1">Vorschau:</div>
                <div id="linkPreview" class="topic-item opacity-50">
                    <a href="#" style="text-decoration: underline; color: var(--primary);">Link Name ‚Üó</a>
                </div>
            </div>
        `;

        // Footer / Actions
        const modalFooter = document.querySelector('#eventDetailModal .modal-footer');
        modalFooter.innerHTML = '';

        const saveBtn = document.createElement('button');
        saveBtn.className = 'btn btn-primary';
        saveBtn.textContent = 'Speichern';
        // Note: The form submit handles the actual saving, but we might want a main save button if we had a single form.
        // Here we follow the previous pattern of separate forms / requests, but the main details form needs a submit.
        // We'll attach the save button to the form submit programmatically or just let the user use the form button?
        // The prompt asked for "Speichern" in the footer.
        saveBtn.setAttribute('form', 'editEventForm'); // Link to the form
        modalFooter.appendChild(saveBtn);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-danger'; // Red color
        deleteBtn.textContent = 'L√∂schen';
        deleteBtn.onclick = deleteCurrentEvent;
        modalFooter.appendChild(deleteBtn);

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn btn-secondary';
        cancelBtn.textContent = 'Schlie√üen'; // Or "Abbrechen" to switch back to view? User said "Schlie√üen" in the request prompt example.
        // Wait, the user said: "Speichern L√∂schen Schlie√üen" in the request.
        // Usually "Schlie√üen" closes the modal.
        // Maybe we should have a "Zur√ºck" to go back to view mode?
        // The prompt "Termin √∂ffnet direkt Bearbeitungsmen√º statt Preview" implies we want preview first.
        // If I am in Edit mode, "Schlie√üen" could just close the modal, or go back. 
        // I'll make it close the modal for now, consistent with "Schlie√üen".
        cancelBtn.onclick = closeEventDetail;
        modalFooter.appendChild(cancelBtn);


        document.getElementById('eventDetailContent').innerHTML = `
            <h3 class="text-sm mb-2">Bearbeiten</h3>
            <form id="editEventForm" onsubmit="submitEditEvent(event, '${event.id}')">
                <div class="form-row">
                    <div class="form-group">
                        <label>Fach</label>
                        <input type="text" name="subject_name" value="${esc(event.subject_name || '')}">
                    </div>
                    <div class="form-group">
                        <label>Datum</label>
                        <input type="date" name="date" value="${event.date || ''}">
                    </div>
                </div>
                <div class="form-group">
                    <label>Details</label>
                    <input type="text" name="title" value="${esc(event.title || '')}">
                </div>
                <div class="form-group">
                    <label>Priorit√§t</label>
                    <select name="priority">
                        <option value="medium" ${(!event.priority || event.priority === 'medium') ? 'selected' : ''}>Normal (Standard)</option>
                        <option value="high" ${event.priority === 'high' ? 'selected' : ''}>Hoch üî¥</option>
                        <option value="low" ${event.priority === 'low' ? 'selected' : ''}>Niedrig</option>
                    </select>
                </div>
                <!-- Hidden submit button to allow Enter key to work -->
                <button type="submit" style="display:none;"></button>
            </form>

            ${topicsHtml}
            ${linksHtml}
        `;
    }

    async function openEventDetail(eventId) {
        currentEventId = eventId;
        document.getElementById('eventDetailModal').classList.add('active');

        // Initial call
        await refreshEventDetailContent(eventId);
    }

    function closeEventDetail() {
        document.getElementById('eventDetailModal').classList.remove('active');
        currentEventId = null;
        currentEventData = null;
    }

    function deleteCurrentEvent() {
        if (!currentEventId) return;
        showConfirm('Termin wirklich l√∂schen?', async () => {
            await fetch(`/events/${currentEventId}`, { method: 'DELETE' });
            location.reload();
        });
    }

    async function submitEditEvent(e, eventId) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        await fetch(`/events/${eventId}`, { method: 'PUT', body: formData });
        // Refresh data and stay in edit mode or go back to view? 
        // Usually save -> view updated data.
        const res = await fetch(`/events/${eventId}`);
        if (res.ok) {
            currentEventData = await res.json();
            renderViewMode();
            showToast('√Ñnderungen gespeichert', 'success');
        }
    }

    async function addTopic(e, eventId) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);

        const res = await fetch(`/events/${eventId}/topics`, { method: 'POST', body: formData });
        if (res.ok) {
            showToast('Thema hinzugef√ºgt', 'success');
            // Update local data and re-render edit mode
            await reloadAndRender(eventId, 'edit');
            // Note: Form is re-rendered, so inputs are effectively cleared
        }
    }

    function deleteTopic(eventId, topicId) {
        showConfirm('Thema l√∂schen?', async () => {
            await fetch(`/events/${eventId}/topics/${topicId}`, { method: 'DELETE' });
            await reloadAndRender(eventId, 'edit');
            showToast('Thema gel√∂scht', 'info');
        });
    }

    async function addLink(e, eventId) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const res = await fetch(`/events/${eventId}/links`, { method: 'POST', body: formData });
        if (res.ok) {
            showToast('Link hinzugef√ºgt', 'success');
            await reloadAndRender(eventId, 'edit');
        }
    }

    function deleteLink(eventId, linkId) {
        showConfirm('Link l√∂schen?', async () => {
            await fetch(`/events/${eventId}/links/${linkId}`, { method: 'DELETE' });
            await reloadAndRender(eventId, 'edit');
            showToast('Link gel√∂scht', 'info');
        });
    }

    async function reloadAndRender(eventId, mode) {
        const res = await fetch(`/events/${eventId}`);
        if (res.ok) {
            currentEventData = await res.json();
            if (mode === 'edit') renderEditMode();
            else renderViewMode();
        }
    }

    // === Upgrade Account Nag ===
    // Use simple string check for template boolean
    const IS_REGISTERED = {{ 'true' if user.is_registered else 'false' }};

    function showUpgradeModal() {
        if (IS_REGISTERED) return;
        if (localStorage.getItem('upgrade_nagged')) return;

        // Slight delay for better UX
        setTimeout(() => {
            document.getElementById('upgradeModal').style.display = 'flex';
        }, 1500);
    }

    function closeUpgradeModal(neverShowAgain = false) {
        document.getElementById('upgradeModal').style.display = 'none';
        if (neverShowAgain) {
            localStorage.setItem('upgrade_nagged', 'true');
        }
    }

    // Initialize Nag
    if (!IS_REGISTERED) showUpgradeModal();

    document.querySelectorAll('.modal-backdrop').forEach(m => {
        m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
    });
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') document.querySelectorAll('.modal-backdrop').forEach(m => m.classList.remove('active'));
    });

    // Show welcome back message if user was already logged in
    {% if welcome_back %}
    setTimeout(() => {
        showToast('Willkommen zur√ºck, {{ user.name }}! üëã', 'success');
        // Clean up the URL without reloading
        if (window.history.replaceState) {
            const url = new URL(window.location);
            url.searchParams.delete('welcome_back');
            window.history.replaceState({}, '', url);
        }
    }, 500);
    {% endif %}

    // === MULTI-FILTER LOGIC ===
    const FilterState = {
        subjects: [],
        types: [],
        priority: [] // Reserved
    };

    const IS_GUEST = USER_ROLE === 'guest';
    const PREFS_API_URL = '/preferences';

    // Init - Load Filters
    async function initFilters() {
        if (IS_GUEST) {
            loadFiltersLocal();
        } else {
            await loadFiltersRemote();
        }
        renderFilterState();
        applyFilters();
    }

    // Load from LocalStorage
    function loadFiltersLocal() {
        const stored = localStorage.getItem('classly_filters');
        if (stored) {
            const parsed = JSON.parse(stored);
            FilterState.subjects = parsed.subjects || [];
            FilterState.types = parsed.types || [];
        }
    }

    // Load from API
    async function loadFiltersRemote() {
        try {
            const res = await fetch(PREFS_API_URL);
            if (res.ok) {
                const data = await res.json();
                FilterState.subjects = data.filter_subjects || [];
                FilterState.types = data.filter_event_types || [];
            }
        } catch (e) {
            console.error("Failed to load prefs", e);
        }
    }

    // Save Filters
    function saveFilters() {
        if (IS_GUEST) {
            localStorage.setItem('classly_filters', JSON.stringify(FilterState));
        } else {
            // Debounce or just save
            fetch(PREFS_API_URL, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    filter_subjects: FilterState.subjects,
                    filter_event_types: FilterState.types,
                    filter_priority: FilterState.priority
                })
            });
        }
    }

    // Toggle Filter Logic
    function toggleFilter(category, value, el) {
        let list;
        if (category === 'subject') list = FilterState.subjects;
        else if (category === 'type') list = FilterState.types;
        else if (category === 'priority') list = FilterState.priority;
        else return;

        const idx = list.indexOf(value);
        if (idx > -1) {
            list.splice(idx, 1); // Remove
        } else {
            list.push(value); // Add
        }

        saveFilters();
        renderFilterState();
        applyFilters();
    }

    // Update UI Chips
    function renderFilterState() {
        // Clear all active classes
        document.querySelectorAll('.filter-chip').forEach(el => el.classList.remove('active'));

        // Apply active to subjects
        FilterState.subjects.forEach(id => {
            const el = document.querySelector(`.filter-chip[data-filter-type="subject"][data-value="${id}"]`);
            if (el) el.classList.add('active');
        });

        // Apply active to types
        FilterState.types.forEach(type => {
            const el = document.querySelector(`.filter-chip[data-filter-type="type"][data-value="${type}"]`);
            if (el) el.classList.add('active');
        });

        // Apply active to priorities
        FilterState.priority.forEach(p => {
            const el = document.querySelector(`.filter-chip[data-filter-type="priority"][data-value="${p}"]`);
            if (el) el.classList.add('active');
        });

        // Update count text
        const totalFilters = FilterState.subjects.length + FilterState.types.length + FilterState.priority.length;
        const countEl = document.getElementById('activeFilterCount');
        if (totalFilters === 0) {
            countEl.innerText = "Alle Termine sichtbar";
        } else {
            countEl.innerText = `${totalFilters} Filter aktiv`;
        }
    }

    // Apply Logic to DOM
    function applyFilters() {
        const events = document.querySelectorAll('.filterable-event');
        let visibleCount = 0;

        events.forEach(el => {
            const type = el.dataset.type;
            const subject = el.dataset.subject; // might be empty string

            // Check Subject Filter (if active, event must match one of the subjects)
            let subjectMatch = true;
            if (FilterState.subjects.length > 0) {
                // If event has no subject, and we are filtering by subject, should it be shown?
                // Usually "Other/All" is hidden if specific subjects are selected.
                // Assuming stricter filtering: Must match.
                subjectMatch = FilterState.subjects.includes(subject);
            }

            // Check Type Filter
            let typeMatch = true;
            if (FilterState.types.length > 0) {
                typeMatch = FilterState.types.includes(type);
            }

            // Check Priority Filter
            let priorityMatch = true;
            if (FilterState.priority.length > 0) {
                // If event has no priority (default?), element dataset might act weird if empty.
                // But we rendered it as 'priority-medium' or something.
                const p = el.dataset.priority || 'medium';
                priorityMatch = FilterState.priority.includes(p);
            }

            if (subjectMatch && typeMatch && priorityMatch) {
                el.classList.remove('hidden');
                visibleCount++;
            } else {
                el.classList.add('hidden');
            }
        });
    }

    function resetFilters() {
        FilterState.subjects = [];
        FilterState.types = [];
        FilterState.priority = [];
        saveFilters();
        renderFilterState();
        applyFilters();
    }

    function toggleFilterContent() {
        const content = document.getElementById('filterContent');
        const icon = document.getElementById('filterCollapseIcon');
        const isHidden = content.style.display === 'none';

        if (isHidden) {
            content.style.display = 'block';
            icon.innerText = '‚ñ≤';
        } else {
            content.style.display = 'none';
            icon.innerText = '‚ñº';
        }
    }

    // Init on load
    document.addEventListener('DOMContentLoaded', initFilters);

    // === GRADE MANAGEMENT ===
    function openGradeModal(eventId, existingGrade = null, existingWeight = null, eventType = 'KA') {
        document.getElementById('gradeEventId').value = eventId;
        document.getElementById('gradeEventType').value = eventType;
        const gradeInput = document.getElementById('gradeInput');
        const weightSelect = document.getElementById('gradeWeight');

        if (existingGrade) {
            gradeInput.value = existingGrade;
        } else {
            gradeInput.value = '';
        }

        // Set default weight based on event type
        if (existingWeight) {
            weightSelect.value = existingWeight.toString();
        } else if (eventType === 'TEST') {
            weightSelect.value = '0.5';
        } else {
            weightSelect.value = '1.0';
        }

        updateGradePreview();
        document.getElementById('gradeModal').classList.add('active');
        gradeInput.focus();
    }

    function closeGradeModal() {
        document.getElementById('gradeModal').classList.remove('active');
        document.getElementById('gradeInput').value = '';
    }

    function updateGradePreview() {
        const gradeInput = document.getElementById('gradeInput');
        const previewBox = document.getElementById('gradePreviewBox');
        const previewValue = document.getElementById('gradePreviewValue');
        const value = parseFloat(gradeInput.value);

        if (isNaN(value) || value < 1 || value > 6) {
            previewBox.style.display = 'none';
            return;
        }

        previewBox.style.display = 'block';
        previewValue.textContent = value.toFixed(1);

        // Update color based on grade
        previewValue.classList.remove('grade-good', 'grade-medium', 'grade-bad');
        if (value <= 2.0) {
            previewValue.classList.add('grade-good');
        } else if (value <= 3.5) {
            previewValue.classList.add('grade-medium');
        } else {
            previewValue.classList.add('grade-bad');
        }
    }

    async function submitGrade(e) {
        e.preventDefault();
        const eventId = document.getElementById('gradeEventId').value;
        const grade = document.getElementById('gradeInput').value;
        const weight = document.getElementById('gradeWeight').value;

        // Validate
        const gradeNum = parseFloat(grade);
        if (isNaN(gradeNum) || gradeNum < 1 || gradeNum > 6) {
            showToast('Note muss zwischen 1.0 und 6.0 sein', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('event_id', eventId);
        formData.append('grade', grade);
        formData.append('weight', weight);

        try {
            const res = await fetch('/grades', {
                method: 'POST',
                body: formData
            });

            if (res.ok) {
                showToast('Note gespeichert! üìù', 'success');
                closeGradeModal();
                // Refresh current event detail if open
                if (currentEventId === eventId) {
                    await refreshEventDetailContent(eventId);
                }
                // Reload page to update widget
                setTimeout(() => location.reload(), 500);
            } else {
                const data = await res.json();
                showToast(data.detail || 'Fehler beim Speichern', 'error');
            }
        } catch (err) {
            showToast('Netzwerkfehler', 'error');
        }
    }

    async function loadGradeForEvent(eventId) {
        if (!IS_REGISTERED) return null;

        try {
            const res = await fetch(`/grades/event/${eventId}`);
            if (res.ok) {
                const data = await res.json();
                return data;
            }
        } catch (e) {
            console.error('Failed to load grade', e);
        }
        return null;
    }
</script>

