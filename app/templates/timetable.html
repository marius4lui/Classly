{% extends "base.html" %}

{% block title %}{{ request.state.t('timetable.title') }} - Classly{% endblock %}

{% block content %}
<div class="timetable-page">
    <header class="timetable-header">
        <div>
            <a href="/" class="btn btn-ghost">‚Üê {{ request.state.t('common.back') }}</a>
            <h1>üìÖ {{ request.state.t('timetable.title') }}</h1>
        </div>
        {% if user.role.value in ['owner', 'admin', 'class_admin'] %}
        <div class="flex gap-2">
            <button class="btn btn-ghost" onclick="openTimetableSettingsModal('share')">üîó {{ request.state.t('timetable.share_button') }}</button>
            <button class="btn btn-primary" onclick="openTimetableSettingsModal('slots')">‚öôÔ∏è {{
                request.state.t('common.edit') }}</button>
        </div>
        {% endif %}
    </header>

    <!-- Mobile Day Tabs -->
    <div class="timetable-tabs" id="dayTabs">
        <button class="tab active" onclick="showDay(0)">{{ request.state.t('timetable.weekdays.short.mo') }}</button>
        <button class="tab" onclick="showDay(1)">{{ request.state.t('timetable.weekdays.short.di') }}</button>
        <button class="tab" onclick="showDay(2)">{{ request.state.t('timetable.weekdays.short.mi') }}</button>
        <button class="tab" onclick="showDay(3)">{{ request.state.t('timetable.weekdays.short.do') }}</button>
        <button class="tab" onclick="showDay(4)">{{ request.state.t('timetable.weekdays.short.fr') }}</button>
    </div>

    <!-- Timetable Grid -->
    <div class="timetable-container card bg-base-100 shadow-xl overflow-hidden">
        <table class="timetable-table" id="timetableTable">
            <thead>
                <tr>
                    <th class="time-col">{{ request.state.t('timetable.table.time') }}</th>
                    <th class="day-col" data-day="0">{{ request.state.t('timetable.weekdays.long.mo') }}</th>
                    <th class="day-col" data-day="1">{{ request.state.t('timetable.weekdays.long.di') }}</th>
                    <th class="day-col" data-day="2">{{ request.state.t('timetable.weekdays.long.mi') }}</th>
                    <th class="day-col" data-day="3">{{ request.state.t('timetable.weekdays.long.do') }}</th>
                    <th class="day-col" data-day="4">{{ request.state.t('timetable.weekdays.long.fr') }}</th>
                </tr>
            </thead>
            <tbody id="timetableBody">
                <!-- Rows will be rendered by JS -->
            </tbody>
        </table>

        <div id="loadingTimetable" class="text-center text-muted py-8">
            <span class="loading loading-spinner loading-lg"></span>
            <p class="mt-2">{{ request.state.t('timetable.loading') }}</p>
        </div>
    </div>

    <!-- Legend -->
    <div class="mt-4 text-xs text-muted text-center" id="timetableLegend">
        {{ request.state.t('timetable.legend_hint') }}
    </div>
</div>

<!-- Timetable Settings Modal (Admin) -->
<div class="modal-backdrop" id="timetableSettingsModal">
    <div class="modal" style="max-width: 600px;">
        <div class="modal-header">
            <h2>‚öôÔ∏è {{ request.state.t('timetable.modal.edit_title') }}</h2>
            <button class="btn btn-ghost" onclick="closeTimetableSettingsModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <!-- Tabs -->
            <div class="tabs tabs-boxed mb-4" role="tablist" aria-label="{{ request.state.t('timetable.modal.edit_title') }}">
                <button type="button" class="tab tab-active" onclick="showSettingsTab('slots', this)">{{ request.state.t('timetable.tabs.slots') }}</button>
                <button type="button" class="tab" onclick="showSettingsTab('settings', this)">{{ request.state.t('timetable.tabs.settings') }}</button>
                <button type="button" class="tab" onclick="showSettingsTab('share', this)">{{ request.state.t('timetable.tabs.share') }}</button>
            </div>

            <!-- Slots Tab -->
            <div id="slotsTab">
                <div class="slot-editor-grid custom-scrollbar" id="slotEditorGrid">
                    <!-- Will be rendered by JS -->
                </div>

                <hr class="my-4" style="border: 0; border-top: 1px solid var(--border-color);">

                <div
                    style="background: var(--bg-card); border: 1px solid var(--border-color); padding: 1rem; border-radius: var(--radius);">
                    <h3 class="text-sm font-bold mb-3">{{ request.state.t('timetable.modal.add_slot_title') }}</h3>
                    <form id="addSlotForm" onsubmit="addSlot(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="label-text text-xs mb-1 block font-bold">{{ request.state.t('timetable.labels.day') }}</label>
                                <select id="newSlotDay" class="select w-full" required>
                                    <option value="0">{{ request.state.t('timetable.weekdays.long.mo') }}</option>
                                    <option value="1">{{ request.state.t('timetable.weekdays.long.di') }}</option>
                                    <option value="2">{{ request.state.t('timetable.weekdays.long.mi') }}</option>
                                    <option value="3">{{ request.state.t('timetable.weekdays.long.do') }}</option>
                                    <option value="4">{{ request.state.t('timetable.weekdays.long.fr') }}</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="label-text text-xs mb-1 block font-bold">{{ request.state.t('timetable.labels.slots') }}</label>
                                <div id="newSlotNumbers" class="slot-number-picker">
                                    {% for i in range(1, 13) %}
                                    <input class="slot-number-input" type="checkbox" id="slotNum{{ i }}" value="{{ i }}"
                                        {% if i==1 %}checked{% endif %}>
                                    <label class="slot-number-toggle" for="slotNum{{ i }}">{{ i }}</label>
                                    {% endfor %}
                                </div>
                                <div class="slot-number-actions">
                                    <button type="button" class="btn btn-ghost btn-sm"
                                        onclick="selectAllSlotNumbers(true)">{{ request.state.t('timetable.buttons.all') }}</button>
                                    <button type="button" class="btn btn-ghost btn-sm"
                                        onclick="selectAllSlotNumbers(false)">{{ request.state.t('timetable.buttons.none') }}</button>
                                </div>
                                <div class="text-xs text-muted mt-1">{{ request.state.t('timetable.hints.multi_select') }}</div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex: 2">
                                <label class="label-text text-xs mb-1 block font-bold">{{ request.state.t('timetable.labels.subject') }}</label>
                                <input type="text" id="newSlotSubject" class="input w-full" placeholder="{{ request.state.t('timetable.placeholders.subject_example') }}"
                                    required>
                            </div>
                            <div class="form-group" style="flex: 1">
                                <label class="label-text text-xs mb-1 block font-bold">{{ request.state.t('timetable.labels.group') }}</label>
                                <input type="text" id="newSlotGroup" class="input w-full" placeholder="{{ request.state.t('timetable.placeholders.group_example') }}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="label-text text-xs mb-1 block font-bold">{{ request.state.t('timetable.labels.room') }}</label>
                            <input type="text" id="newSlotRoom" class="input w-full" placeholder="{{ request.state.t('timetable.placeholders.room_example') }}">
                        </div>
                        <button type="submit" class="btn btn-primary btn-block" style="margin-top: 1rem;">+
                            {{ request.state.t('timetable.buttons.add') }}</button>
                    </form>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" style="display: none;">
                <form id="settingsForm" onsubmit="saveSettings(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="label-text text-xs mb-1 block font-bold">{{ request.state.t('timetable.labels.duration_minutes') }}</label>
                            <input type="number" id="slotDuration" name="slot_duration" class="input w-full" value="45">
                        </div>
                        <div class="form-group">
                            <label class="label-text text-xs mb-1 block font-bold">{{ request.state.t('timetable.labels.break_minutes') }}</label>
                            <input type="number" id="breakDuration" name="break_duration" class="input w-full"
                                value="15">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="label-text text-xs mb-1 block font-bold">{{ request.state.t('timetable.labels.start') }}</label>
                            <input type="time" id="dayStart" class="input w-full">
                        </div>
                        <div class="form-group">
                            <label class="label-text text-xs mb-1 block font-bold">{{ request.state.t('timetable.labels.end') }}</label>
                            <input type="time" id="dayEnd" class="input w-full">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success btn-block" style="margin-top: 1rem;">{{ request.state.t('timetable.buttons.save_settings') }}</button>
                </form>
            </div>

            <!-- Share Tab -->
            <div id="shareTab" style="display: none;">
                <div
                    style="background: var(--bg-card); border: 1px solid var(--border-color); padding: 1rem; border-radius: var(--radius);">
                    <h3 class="text-sm font-bold mb-2">{{ request.state.t('timetable.labels.public_link_title') }}</h3>
                    <p class="text-xs text-muted mb-3">
                        {{ request.state.t('timetable.hints.public_description') }}
                    </p>

                    <div class="form-group mb-3">
                        <label class="label-text text-xs mb-1 block font-bold">{{ request.state.t('timetable.labels.link') }}</label>
                        <div class="flex gap-2">
                            <input type="text" id="publicTimetableLink" class="input w-full" readonly value="">
                            <button class="btn btn-ghost" type="button" onclick="copyPublicLink()">{{ request.state.t('common.copy') }}</button>
                        </div>
                        <div class="text-xs text-muted mt-1" id="publicTimetableStatus"></div>
                    </div>

                    <div class="flex gap-2 flex-wrap">
                        <button class="btn btn-primary" type="button" onclick="enableOrRotatePublicLink()">{{ request.state.t('timetable.buttons.enable_rotate') }}</button>
                        <button class="btn btn-ghost" type="button" onclick="disablePublicLink()">{{ request.state.t('timetable.buttons.disable') }}</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Edit Modal (Admin) -->
<div class="modal-backdrop" id="quickEditModal">
    <div class="modal" style="max-width: 520px;">
        <div class="modal-header">
            <h2>‚úèÔ∏è <span id="qeTitle">{{ request.state.t('timetable.modal.quick_edit_title') }}</span></h2>
            <button class="btn btn-ghost" onclick="closeQuickEditModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="label-text text-xs mb-1 block font-bold">{{ request.state.t('timetable.labels.subject') }}</label>
                <input type="text" id="qeSubject" class="input w-full" placeholder="{{ request.state.t('timetable.placeholders.subject_example') }}" required>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 1">
                    <label class="label-text text-xs mb-1 block font-bold">{{ request.state.t('timetable.labels.group') }}</label>
                    <input type="text" id="qeGroup" class="input w-full" placeholder="{{ request.state.t('timetable.placeholders.group_example') }}">
                </div>
                <div class="form-group" style="flex: 1">
                    <label class="label-text text-xs mb-1 block font-bold">{{ request.state.t('timetable.labels.room') }}</label>
                    <input type="text" id="qeRoom" class="input w-full" placeholder="{{ request.state.t('timetable.placeholders.room_example') }}">
                </div>
            </div>

            <div class="flex gap-2 flex-wrap" style="margin-top: 1rem;">
                <button class="btn btn-primary" type="button" onclick="saveQuickEdit()">{{ request.state.t('common.save') }}</button>
                <button class="btn btn-ghost text-error" type="button" onclick="deleteQuickEdit()">{{ request.state.t('common.delete') }}</button>
            </div>
        </div>
    </div>
</div>

<script>
    const IS_ADMIN = {{ 'true' if user.role.value in ['owner', 'admin', 'class_admin']else 'false' }};
    // The timetable is available to any logged-in class member, not only users
    // that registered with email/password.
    const CAN_SELECT = true;
    const I18N = {{ {
        "weekdays_long": [
            request.state.t('timetable.weekdays.long.mo'),
            request.state.t('timetable.weekdays.long.di'),
            request.state.t('timetable.weekdays.long.mi'),
            request.state.t('timetable.weekdays.long.do'),
            request.state.t('timetable.weekdays.long.fr')
        ],
        "slot_unit": request.state.t('timetable.slot_unit'),
        "messages": {
            "load_failed": request.state.t('timetable.messages.load_failed'),
            "settings_saved": request.state.t('timetable.messages.settings_saved'),
            "no_slots": request.state.t('timetable.messages.no_slots'),
            "select_at_least_one_slot": request.state.t('timetable.messages.select_at_least_one_slot'),
            "delete_slot_confirm": request.state.t('timetable.messages.delete_slot_confirm'),
            "subject_required": request.state.t('timetable.messages.subject_required'),
            "save_failed": request.state.t('timetable.messages.save_failed'),
            "delete_failed": request.state.t('timetable.messages.delete_failed'),
            "copy_success": request.state.t('timetable.messages.copy_success'),
            "link_generate_failed": request.state.t('timetable.messages.link_generate_failed'),
            "link_disable_failed": request.state.t('timetable.messages.link_disable_failed')
        },
        "status": {
            "loading": request.state.t('timetable.status.loading'),
            "active": request.state.t('timetable.status.active'),
            "disabled": request.state.t('timetable.status.disabled'),
            "load_failed": request.state.t('timetable.status.load_failed')
        },
        "labels": {
            "subject": request.state.t('timetable.labels.subject'),
            "group": request.state.t('timetable.labels.group'),
            "room": request.state.t('timetable.labels.room')
        },
        "buttons": {
            "save": request.state.t('common.save')
        }
    } | tojson }};
    const WEEKDAYS = I18N.weekdays_long;

    let timetableData = { slots: [] };
    let settingsData = {};

    async function loadTimetable() {
        try {
            const [slotsRes, settingsRes] = await Promise.all([
                fetch('/timetable/my'),
                fetch('/timetable/settings')
            ]);

            if (slotsRes.ok) timetableData = await slotsRes.json();
            if (settingsRes.ok) settingsData = await settingsRes.json();

            renderTimetable();
            document.getElementById('loadingTimetable').style.display = 'none';
        } catch (e) {
            console.error(e);
            const loader = document.getElementById('loadingTimetable');
            loader.innerHTML = `<span class="text-error">${I18N.messages.load_failed}</span>`;
        }
    }

    function renderTimetable() {
        const tbody = document.getElementById('timetableBody');
        tbody.innerHTML = '';

        // Find max slot number
        let maxSlot = 8;
        if (timetableData.slots.length > 0) {
            maxSlot = Math.max(...timetableData.slots.map(s => s.slot_number), 8);
        }

        // Generate rows
        for (let slotNum = 1; slotNum <= maxSlot; slotNum++) {
            const row = document.createElement('tr');

            // Time cell
            const timeCell = document.createElement('td');
            timeCell.className = 'time-cell';

            // Find time from any slot in this number (assuming consistent times)
            // Or calculate if we implemented that fully on frontend, but backend sends it
            const anySlot = timetableData.slots.find(s => s.slot_number === slotNum);
            const startTime = anySlot ? anySlot.start_time : '';
            const endTime = anySlot ? anySlot.end_time : '';

            timeCell.innerHTML = `
            <div class="slot-number">${slotNum}.</div>
            <div class="slot-time">${startTime}</div>
            <div class="slot-time text-xs opacity-50">${endTime}</div>
        `;
            row.appendChild(timeCell);

            // Day cells
            for (let day = 0; day < 5; day++) {
                const daySlots = timetableData.slots.filter(s => s.weekday === day && s.slot_number === slotNum);
                const cell = document.createElement('td');
                cell.className = 'day-cell';
                cell.dataset.day = day;

                if (daySlots.length === 0) {
                    // Empty cell
                } else if (daySlots.length === 1) {
                    const s = daySlots[0];
                    cell.innerHTML = renderSlotContent(s);
                    if (s.selected) cell.classList.add('selected');
                    cell.onclick = () => handleSlotClick(s);
                } else {
                    // Multiple groups
                    const container = document.createElement('div');
                    container.className = 'multi-slot-container';
                    daySlots.forEach(s => {
                        const div = document.createElement('div');
                        div.className = `slot-item ${s.selected ? 'selected' : ''}`;
                        div.innerHTML = renderSlotContent(s, true);
                        div.onclick = (e) => { e.stopPropagation(); handleSlotClick(s); };
                        container.appendChild(div);
                    });
                    cell.appendChild(container);
                }

                row.appendChild(cell);
            }

            tbody.appendChild(row);
        }

        // Apply responsive visibility: mobile shows one day, desktop shows all days.
        applyResponsiveDayVisibility();
    }

    function renderSlotContent(slot, compact = false) {
        if (compact) {
            return `
            <div class="font-bold text-sm">${slot.subject_name}</div>
            <div class="text-xs flex justify-between">
                <span>${slot.group_name || ''}</span>
                <span>${slot.room || ''}</span>
            </div>
        `;
        }
        return `
        <div class="slot-subject">${slot.subject_name}</div>
        ${slot.group_name ? `<div class="badge badge-sm badge-ghost my-1">${slot.group_name}</div>` : ''}
        ${slot.room ? `<div class="slot-room">üìç ${slot.room}</div>` : ''}
    `;
    }

    function handleSlotClick(slot) {
        if (IS_ADMIN) {
            openQuickEditSlot(slot.id);
            return;
        }
        toggleSlotSelection(slot.id, slot.selected);
    }

    async function toggleSlotSelection(slotId, currentlySelected) {
        if (!CAN_SELECT) return;

        const method = currentlySelected ? 'DELETE' : 'POST';
        await fetch(`/timetable/select/${slotId}`, { method });
        // Optimistic update
        const slot = timetableData.slots.find(s => s.id === slotId);
        if (slot) slot.selected = !currentlySelected;
        renderTimetable(); // Re-render to show change

        // Background refresh
        loadTimetable();
    }

    function showAllDays() {
        document.querySelectorAll('.day-col').forEach(th => {
            th.style.display = 'table-cell';
        });
        document.querySelectorAll('.day-cell').forEach(td => {
            td.style.display = 'table-cell';
        });
    }

    function showDay(dayIndex) {
        // Mobile-only view: hide/show columns.
        // If we're on desktop, ensure everything is visible.
        if (window.innerWidth >= 768) {
            showAllDays();
            return;
        }

        document.querySelectorAll('#dayTabs .tab').forEach((t, i) => {
            t.classList.toggle('tab-active', i === dayIndex);
        });

        // In table, we hide TH and TD cells for other days
        document.querySelectorAll('.day-col').forEach((th, i) => {
            th.style.display = (i === dayIndex) ? 'table-cell' : 'none';
        });

        document.querySelectorAll('.day-cell').forEach(td => {
            const day = parseInt(td.dataset.day);
            td.style.display = (day === dayIndex) ? 'table-cell' : 'none';
        });
    }

    function applyResponsiveDayVisibility() {
        const isMobile = window.innerWidth < 768;
        if (!isMobile) {
            showAllDays();
            return;
        }

        const today = new Date().getDay();
        if (today >= 1 && today <= 5) {
            showDay(today - 1);
        } else {
            showDay(0); // Default to Monday
        }
    }

    // Settings Modal
    function openTimetableSettingsModal(initialTab = 'slots') {
        document.getElementById('timetableSettingsModal').classList.add('active');
        loadSettingsForm();
        loadSlotsEditor();
        loadPublicLinkStatus();
        const tabEls = Array.from(document.querySelectorAll('.tabs .tab'));
        const idx = initialTab === 'settings' ? 1 : initialTab === 'share' ? 2 : 0;
        showSettingsTab(initialTab, tabEls[idx]);
    }

    function closeTimetableSettingsModal() {
        document.getElementById('timetableSettingsModal').classList.remove('active');
    }

    function showSettingsTab(tabName, tabElement) {
        document.getElementById('settingsTab').style.display = tabName === 'settings' ? 'block' : 'none';
        document.getElementById('slotsTab').style.display = tabName === 'slots' ? 'block' : 'none';
        document.getElementById('shareTab').style.display = tabName === 'share' ? 'block' : 'none';

        // Update active tab visual
        if (tabElement) {
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('tab-active'));
            tabElement.classList.add('tab-active');
        }
    }

    async function loadSettingsForm() {
        const res = await fetch('/timetable/settings');
        if (res.ok) {
            const data = await res.json();
            document.getElementById('slotDuration').value = data.slot_duration;
            document.getElementById('breakDuration').value = data.break_duration;
            document.getElementById('dayStart').value = `${String(data.day_start_hour).padStart(2, '0')}:${String(data.day_start_minute).padStart(2, '0')}`;
            document.getElementById('dayEnd').value = `${String(data.day_end_hour).padStart(2, '0')}:${String(data.day_end_minute).padStart(2, '0')}`;
        }
    }

    async function saveSettings(e) {
        e.preventDefault();
        const startTime = document.getElementById('dayStart').value.split(':');
        const endTime = document.getElementById('dayEnd').value.split(':');

        const formData = new FormData();
        formData.append('slot_duration', document.getElementById('slotDuration').value);
        formData.append('break_duration', document.getElementById('breakDuration').value);
        formData.append('day_start_hour', startTime[0]);
        formData.append('day_start_minute', startTime[1]);
        formData.append('day_end_hour', endTime[0]);
        formData.append('day_end_minute', endTime[1]);

        await fetch('/timetable/settings', { method: 'PUT', body: formData });
        await loadTimetable();
        alert(I18N.messages.settings_saved);
    }

    async function loadSlotsEditor() {
        const res = await fetch('/timetable/slots');
        if (!res.ok) return;

        const data = await res.json();
        const grid = document.getElementById('slotEditorGrid');

        if (data.slots.length === 0) {
            grid.innerHTML = `<p class="text-muted text-center py-4">${I18N.messages.no_slots}</p>`;
            return;
        }

        grid.innerHTML = data.slots.map(s => `
        <div class="slot-editor-item">
            <div class="slot-editor-main">
                <div class="slot-editor-title">
                    <strong>${WEEKDAYS[s.weekday]}, ${s.slot_number}. ${I18N.slot_unit}</strong>
                </div>
                <div class="slot-editor-fields">
                    <input class="input" id="editSubject_${s.id}" value="${escapeHtml(s.subject_name || '')}" placeholder="${escapeHtml(I18N.labels.subject)}" />
                    <input class="input" id="editGroup_${s.id}" value="${escapeHtml(s.group_name || '')}" placeholder="${escapeHtml(I18N.labels.group)}" />
                    <input class="input" id="editRoom_${s.id}" value="${escapeHtml(s.room || '')}" placeholder="${escapeHtml(I18N.labels.room)}" />
                </div>
                <div class="slot-editor-actions">
                    <button type="button" class="btn btn-ghost btn-sm" onclick="saveSlotEdit('${s.id}')">${I18N.buttons.save}</button>
                    <button type="button" class="btn btn-ghost btn-sm text-error" onclick="deleteSlot('${s.id}')">üóëÔ∏è</button>
                </div>
            </div>
        </div>
    `).join('');
    }

    async function addSlot(e) {
        e.preventDefault();

        const slotNums = Array.from(document.querySelectorAll('#newSlotNumbers input[type=\"checkbox\"]:checked'))
            .map(el => parseInt(el.value, 10))
            .filter(n => !Number.isNaN(n));
        if (slotNums.length === 0) {
            alert(I18N.messages.select_at_least_one_slot);
            return;
        }

        const formData = new FormData();
        formData.append('weekday', document.getElementById('newSlotDay').value);
        slotNums.forEach(n => formData.append('slot_numbers', String(n)));
        formData.append('subject_name', document.getElementById('newSlotSubject').value);
        formData.append('group_name', document.getElementById('newSlotGroup').value);
        formData.append('room', document.getElementById('newSlotRoom').value);

        const res = await fetch('/timetable/slots/bulk', { method: 'POST', body: formData });
        if (res.ok) {
            document.getElementById('newSlotSubject').value = '';
            document.getElementById('newSlotGroup').value = '';
            document.getElementById('newSlotRoom').value = '';
            await loadSlotsEditor();
            await loadTimetable();
        }
    }

    function selectAllSlotNumbers(enabled) {
        document.querySelectorAll('#newSlotNumbers input[type=\"checkbox\"]').forEach(el => {
            el.checked = !!enabled;
        });
    }

    async function deleteSlot(slotId) {
        if (!confirm(I18N.messages.delete_slot_confirm)) return;
        await fetch(`/timetable/slots/${slotId}`, { method: 'DELETE' });
        await loadSlotsEditor();
        await loadTimetable();
    }

    function escapeHtml(s) {
        return String(s)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#039;');
    }

    async function saveSlotEdit(slotId) {
        const subject = document.getElementById(`editSubject_${slotId}`)?.value?.trim();
        const group = document.getElementById(`editGroup_${slotId}`)?.value?.trim();
        const room = document.getElementById(`editRoom_${slotId}`)?.value?.trim();
        if (!subject) {
            alert(I18N.messages.subject_required);
            return;
        }

        const formData = new FormData();
        formData.append('subject_name', subject);
        formData.append('group_name', group || '');
        formData.append('room', room || '');

        const res = await fetch(`/timetable/slots/${slotId}`, { method: 'PUT', body: formData });
        if (!res.ok) {
            alert(I18N.messages.save_failed);
            return;
        }

        await loadTimetable();
    }

    // Public share helpers (admin only)
    function publicLinkFromCode(code) {
        if (!code) return '';
        return `${window.location.origin}/public/stundenplan/${code}`;
    }

    async function loadPublicLinkStatus() {
        if (!IS_ADMIN) return;
        const statusEl = document.getElementById('publicTimetableStatus');
        const linkEl = document.getElementById('publicTimetableLink');
        if (!statusEl || !linkEl) return;

        statusEl.textContent = I18N.status.loading;
        linkEl.value = '';

        const res = await fetch('/timetable/public/status');
        if (!res.ok) {
            statusEl.textContent = I18N.status.load_failed;
            return;
        }

        const data = await res.json();
        if (data.enabled && data.code) {
            statusEl.textContent = I18N.status.active;
            linkEl.value = publicLinkFromCode(data.code);
        } else {
            statusEl.textContent = I18N.status.disabled;
            linkEl.value = '';
        }
    }

    async function enableOrRotatePublicLink() {
        const res = await fetch('/timetable/public/rotate', { method: 'POST' });
        if (res.ok) {
            await loadPublicLinkStatus();
        } else {
            alert(I18N.messages.link_generate_failed);
        }
    }

    async function disablePublicLink() {
        const res = await fetch('/timetable/public/disable', { method: 'POST' });
        if (res.ok) {
            await loadPublicLinkStatus();
        } else {
            alert(I18N.messages.link_disable_failed);
        }
    }

    async function copyPublicLink() {
        const link = document.getElementById('publicTimetableLink')?.value || '';
        if (!link) return;
        try {
            await navigator.clipboard.writeText(link);
            alert(I18N.messages.copy_success);
        } catch (e) {
            const el = document.getElementById('publicTimetableLink');
            el.focus();
            el.select();
            document.execCommand('copy');
            alert(I18N.messages.copy_success);
        }
    }

    // Quick edit modal for admins (click-to-edit in grid)
    let activeEditSlotId = null;

    function openQuickEditSlot(slotId) {
        const slot = timetableData.slots.find(s => s.id === slotId);
        if (!slot) return;

        activeEditSlotId = slotId;
        document.getElementById('qeTitle').textContent = `${WEEKDAYS[slot.weekday] || ''}, ${slot.slot_number}. ${I18N.slot_unit}`;
        document.getElementById('qeSubject').value = slot.subject_name || '';
        document.getElementById('qeGroup').value = slot.group_name || '';
        document.getElementById('qeRoom').value = slot.room || '';
        document.getElementById('quickEditModal').classList.add('active');
    }

    function closeQuickEditModal() {
        document.getElementById('quickEditModal').classList.remove('active');
        activeEditSlotId = null;
    }

    async function saveQuickEdit() {
        if (!activeEditSlotId) return;
        const subject = document.getElementById('qeSubject').value.trim();
        const group = document.getElementById('qeGroup').value.trim();
        const room = document.getElementById('qeRoom').value.trim();
        if (!subject) {
            alert(I18N.messages.subject_required);
            return;
        }

        const formData = new FormData();
        formData.append('subject_name', subject);
        formData.append('group_name', group || '');
        formData.append('room', room || '');

        const res = await fetch(`/timetable/slots/${activeEditSlotId}`, { method: 'PUT', body: formData });
        if (!res.ok) {
            alert(I18N.messages.save_failed);
            return;
        }

        closeQuickEditModal();
        await loadTimetable();
        await loadSlotsEditor();
    }

    async function deleteQuickEdit() {
        if (!activeEditSlotId) return;
        if (!confirm(I18N.messages.delete_slot_confirm)) return;
        const res = await fetch(`/timetable/slots/${activeEditSlotId}`, { method: 'DELETE' });
        if (!res.ok) {
            alert(I18N.messages.delete_failed);
            return;
        }

        closeQuickEditModal();
        await loadTimetable();
        await loadSlotsEditor();
    }

    // Init
    document.addEventListener('DOMContentLoaded', loadTimetable);

    // Keep day visibility correct when resizing between mobile/desktop.
    window.addEventListener('resize', applyResponsiveDayVisibility);
</script>
{% endblock %}
